def ofbizVersion = '17.12'
def droolsVersion = '7.17.0.Final'
def dashbuilderVersion = '2.14.0.Final'
def uberfireVersion = '2.14.0.Final'
def erraiVersion = '4.4.1.Final'
// lucene 7.1.0
def elasticsearchVersion = '6.1.1'
def luceneVersion = '7.1.0'
// for tomcat 9.0.x
def tomcatVersion = '9.0.31'
def resteasyVersion = '3.0.26.Final'  // cdi-api 1.2
def javassistVersion = '3.20.0-GA'
// other tools
def jgitVersion = '4.8.0.201706111038-r'
def codehausJacksonVersion = '1.9.13'
def infinispanVersion = '9.3.2.Final'
def jacksonVersion = '2.9.5'

// set log4j runtime configuration files
def findLogArg = false
def originalLog4jConfig = ""
def log4jConfig = ""
rootProject.jvmArguments.each { jvmArg ->
    if (jvmArg && jvmArg.startsWith("-Dlog4j.configurationFile=")) {
        originalLog4jConfig = jvmArg
        if (!jvmArg.endsWith("=")) {
            jvmArg += ","
        }
        log4jConfig = jvmArg + "log4j2-drools.xml"
        findLogArg = true
        return true
    }
}
if (!findLogArg) {
    rootProject.jvmArguments.add('-Dlog4j.configurationFile=log4j2.xml,log4j2-drools.xml')
} else {
    rootProject.jvmArguments.remove(originalLog4jConfig)
    rootProject.jvmArguments.add(log4jConfig)
}

rootProject.configurations.each { conf ->
    conf.resolutionStrategy.dependencySubstitution {
        substitute(module('com.fasterxml.jackson.core:jackson-core'))
                     .with(module('com.fasterxml.jackson.core:jackson-core:' + jacksonVersion))
        substitute(module('com.fasterxml.jackson.core:jackson-databind'))
                     .with(module('com.fasterxml.jackson.core:jackson-databind:' + jacksonVersion))
        substitute(module('com.fasterxml.jackson.core:jackson-annotations'))
                     .with(module('com.fasterxml.jackson.core:jackson-annotations:' + jacksonVersion))
    }
}

rootProject.configurations.compile {
    exclude group: 'bouncycastle'
    exclude group: 'org.zapodot', module: 'jackson-databind-java-optional'
    exclude group: 'org.apache.htrace'
    exclude group: 'javax.ws.rs'
}

rootProject.configurations.runtime {
    exclude group: 'bouncycastle'
    exclude group: 'org.apache.logging.log4j', module: 'log4j-to-slf4j'
    exclude group: 'org.uberfire', module: 'uberfire-commons'
    exclude group: 'org.python', module: 'jython'
    exclude group: 'org.zapodot', module: 'jackson-databind-java-optional'
}

// set drools runtime configurations
rootProject.jvmArguments.add('-Dorg.uberfire.nio.git.dir=runtime/drools')
rootProject.jvmArguments.add('-Dappformer.ssh.keys.storage.folder=runtime/drools/.security/pkeys')
rootProject.jvmArguments.add('-Dorg.guvnor.m2repo.dir=runtime/drools/repositories')
rootProject.jvmArguments.add('-Dorg.uberfire.metadata.index.dir=runtime/drools')
rootProject.jvmArguments.add('-Dorg.uberfire.async.executor.safemode=true')
rootProject.jvmArguments.add('-Dorg.uberfire.nio.git.ssh.cert.dir=runtime/drools')
rootProject.jvmArguments.add('-Dorg.kie.wb.common.examples.dir=runtime/drools')
rootProject.jvmArguments.add('-Dorg.jbpm.server.ext.disabled=true')
rootProject.jvmArguments.add('-Dorg.jbpm.ui.server.ext.disabled=true')
rootProject.jvmArguments.add('-Dorg.kie.executor.disabled=true')
rootProject.jvmArguments.add('-Dcom.arjuna.ats.arjuna.objectstore.objectStoreDir=runtime/drools/PutObjectStoreDirHere')
rootProject.jvmArguments.add('-DObjectStoreEnvironmentBean.objectStoreDir=runtime/drools/ObjectStore')
rootProject.jvmArguments.add('-Dorg.jboss.logging.provider=log4j2')

rootProject.jvmArguments.add('-Dorg.appformer.m2repo.url=http://localhost:8080/kie-wb/maven2')
rootProject.jvmArguments.add('-Dorg.uberfire.nio.git.daemon.enabled=true')
rootProject.jvmArguments.add('-Dorg.uberfire.nio.git.daemon.port=9422')
rootProject.jvmArguments.add('-Dorg.uberfire.nio.git.ssh.enabled=false')
rootProject.jvmArguments.add('-Dorg.kie.server.location=http://localhost:8080/kie-server/services/rest/server')
rootProject.jvmArguments.add('-Dorg.kie.server.id=runtime/drools/ofbiz-kie-server')
rootProject.jvmArguments.add('-Dorg.kie.server.user=kieserver')
rootProject.jvmArguments.add('-Dorg.kie.server.pwd=sandflower')
rootProject.jvmArguments.add('-Dorg.kie.server.controller=http://localhost:8080/kie-wb/rest/controller')
rootProject.jvmArguments.add('-Dorg.kie.server.controller.user=kieserver')
rootProject.jvmArguments.add('-Dorg.kie.server.controller.pwd=sandflower')

rootProject.buildscript.repositories.maven({ url "https://repository.mulesoft.org/nexus/content/repositories/public/" })

dependencies {
    pluginLibsCompileOnly 'org.jbpm:jbpm-wb-dashboard-client:' + droolsVersion,
                          'org.jboss.errai:errai-security-server:' + erraiVersion,
                          'org.uberfire:uberfire-security-management-api:' + uberfireVersion,
                          'org.uberfire:uberfire-security-management-backend:' + uberfireVersion,
                          'org.uberfire:uberfire-commons:' + uberfireVersion,
                          'org.uberfire:uberfire-metadata-backend-lucene:' + uberfireVersion,
                          'org.uberfire:uberfire-metadata-backend-elasticsearch:' + uberfireVersion,
                          'org.uberfire:uberfire-metadata-commons-io:' + uberfireVersion,
                          'org.uberfire:uberfire-rest-backend:' + uberfireVersion,
                          'org.uberfire:uberfire-rest-client:' + uberfireVersion,
                          'org.uberfire:uberfire-nio2-jgit:' + uberfireVersion,
                          'com.google.gwt:gwt-user:2.8.2'

    pluginLibsCompile 'org.jbpm:jbpm-kie-services:' + droolsVersion,
                      'org.jbpm:jbpm-runtime-manager:' + droolsVersion,
                      'org.kie.server:kie-server-client:' + droolsVersion,
                      'org.kie.server:kie-server-services-common:' + droolsVersion,
                      'org.kie:kie-tomcat-integration:' + droolsVersion,
                      'org.apache.tomcat:tomcat-util:' + tomcatVersion,
                      'javax.security.jacc:javax.security.jacc-api:1.5',
                      'org.eclipse.jgit:org.eclipse.jgit:' + jgitVersion,
                      'org.eclipse.jgit:org.eclipse.jgit.http.server:' + jgitVersion,
                      'org.elasticsearch:elasticsearch:' + elasticsearchVersion

    pluginLibsRuntime 'org.jbpm:jbpm-bpmn2-emfextmodel:' + droolsVersion,
                      'org.jbpm:jbpm-workitems-bpmn2:' + droolsVersion,
                      'org.jbpm:jbpm-workitems-email:' + droolsVersion,
                      'org.jbpm:jbpm-workitems-jms:' + droolsVersion,
                      'org.jbpm:jbpm-workitems-rest:' + droolsVersion,
                      'org.jbpm:jbpm-workitems-webservice:' + droolsVersion,
                      'org.jbpm:jbpm-case-mgmt-impl:' + droolsVersion,
                      'org.jbpm:jbpm-query-jpa:' + droolsVersion,
                      'org.jbpm:jbpm-executor:' + droolsVersion,
                      'org.drools:drools-decisiontables:' + droolsVersion,
                      'org.drools:drools-scorecards:' + droolsVersion,
                      'org.drools:drools-workbench-models-test-scenarios:' + droolsVersion,
                      'org.drools:drools-workbench-models-guided-scorecard:' + droolsVersion,
                      'org.drools:drools-workbench-models-guided-dtable:' + droolsVersion,
                      'org.drools:drools-workbench-models-guided-dtree:' + droolsVersion,
                      'org.drools:drools-workbench-models-guided-template:' + droolsVersion,
                      'org.drools:jbpm-simulation:' + droolsVersion,
                      'org.kie:kie-dmn-validation:' + droolsVersion,
                      'org.kie:jbpm-process-svg:' + droolsVersion,
                      'org.kie.server:kie-server-rest-common:' + droolsVersion,
                      'org.kie.server:kie-server-rest-case-mgmt:' + droolsVersion,
                      'org.kie.server:kie-server-rest-dmn:' + droolsVersion,
                      'org.kie.server:kie-server-rest-drools:' + droolsVersion,
                      'org.kie.server:kie-server-rest-jbpm:' + droolsVersion,
                      'org.kie.server:kie-server-rest-jbpm-ui:' + droolsVersion,
                      'org.kie.server:kie-server-rest-optaplanner:' + droolsVersion,
                      'org.kie.server:kie-server-rest-swagger:' + droolsVersion,
                      'org.kie.server:kie-server-router-client:' + droolsVersion,
                      'org.kie.soup:kie-soup-dataset-csv:' + droolsVersion,
                      'org.kie.soup:kie-soup-dataset-elasticsearch:' + droolsVersion,
                      'org.kie.uberfire:i18n-taglib:' + droolsVersion,
                      'org.kie.server:kie-server-controller-api:' + droolsVersion,
                      'org.kie.server:kie-server-controller-websocket-common:' + droolsVersion,
                      'org.kie.server:kie-server-controller-websocket-client:' + droolsVersion,
                      'org.optaplanner:optaplanner-persistence-jaxb:' + droolsVersion,
                      'org.optaplanner:optaplanner-workbench-models-datamodel-api:' + droolsVersion,
                      'org.elasticsearch.client:transport:' + elasticsearchVersion,
                      'com.lmax:disruptor:3.4.2',
                      'org.apache.lucene:lucene-codecs:' + luceneVersion,
                      'org.apache.httpcomponents:httpcore-nio:4.4.5',
                      'com.google.guava:guava-gwt:20.0',
                      'org.apache.xmlgraphics:batik-codec:1.9.1',
                      'javax.activation:activation:1.1.1',
                      'net.bytebuddy:byte-buddy:1.8.17',
                      'com.google.elemental2:elemental2-dom:1.0.0-RC1',
                      'org.owasp.encoder:encoder:1.2',
                      'com.google.inject:guice:4.0:no_aop',
                      'com.google.inject.extensions:guice-servlet:4.0',
                      'org.hibernate:hibernate-envers:5.1.15.Final',
                      'org.hibernate.javax.persistence:hibernate-jpa-2.1-api:1.0.0.Final',
                      'org.hibernate:hibernate-validator:4.1.0.Final',
                      'com.fasterxml.jackson.jaxrs:jackson-jaxrs-json-provider:' + jacksonVersion,
                      'org.codehaus.jackson:jackson-core-asl:' + codehausJacksonVersion,
                      'org.codehaus.jackson:jackson-mapper-asl:' + codehausJacksonVersion,
                      'org.codehaus.jackson:jackson-jaxrs:' + codehausJacksonVersion,
                      'org.codehaus.jackson:jackson-xc:' + codehausJacksonVersion,
                      'org.jdom:jdom:1.1.3',
                      'org.jgroups:jgroups:3.6.14.Final',
                      'joda-time:joda-time:2.9.7',
                      'org.json:json:20090211',
                      'org.apache.maven:maven-embedder:3.3.9',
                      'org.eclipse:org.eclipse.bpmn2:0.8.2-jboss',
                      'org.jasypt:jasypt:1.9.2',
                      'org.jboss.classfilewriter:jboss-classfilewriter:1.2.1.Final',
                      'org.jboss.spec.javax.ejb:jboss-ejb-api_3.2_spec:1.0.0.Final',
                      'org.jboss.spec.javax.interceptor:jboss-interceptors-api_1.2_spec:1.0.0.Final',
                      'org.jboss.spec.javax.xml.ws:jboss-jaxws-api_2.2_spec:2.0.4.Final',
                      'org.jboss.resteasy:resteasy-jaxrs:' + resteasyVersion,
                      'org.jboss.resteasy:resteasy-jackson-provider:' + resteasyVersion,
                      'org.jboss.resteasy:resteasy-jaxb-provider:' + resteasyVersion,
                      'org.apache.johnzon:johnzon-core:0.9.5',
                      'org.jboss.forge.roaster:roaster-jdt:2.19.5.Final',
                      'org.apache.mina:mina-core:2.0.15',
                      'io.netty:netty-transport-native-epoll:4.1.16.Final:linux-x86_64',
                      'io.netty:netty-transport-native-kqueue:4.1.16.Final:osx-x86_64',
                      'org.osgi:org.osgi.compendium:4.3.1',
                      'org.osgi:org.osgi.core:4.3.1',
                      'org.ocpsoft.prettytime:prettytime:3.0.2.Final',
                      'org.infinispan.protostream:protostream:4.2.2.Final',
                      'org.yaml:snakeyaml:1.17',
                      'com.unboundid:unboundid-ldapsdk:3.2.0',
                      'org.apache.velocity:velocity:1.7',
                      'org.wildfly.security:wildfly-elytron:1.1.0.Final',
                      'org.apache.abdera:abdera-core:1.1.3',
                      'ch.qos.cal10n:cal10n-api:0.8.1',
                      'com.h2database:h2:1.3.173',
                      'org.jboss.errai.reflections:reflections:4.3.2.Final',
                      'org.scannotation:scannotation:1.0.3',
                      'org.slf4j:slf4j-ext:1.7.25',
                      'org.apache.sshd:sshd-core:1.6.0',
                      'xerces:xercesImpl:2.11.0.SP5',
                      'xml-apis:xml-apis:1.4.01',
                      'javax.json:javax.json-api:1.1.4',
                      'cglib:cglib-nodep:2.2',
                      'stax:stax:1.2.0',
                      'io.swagger:swagger-jaxrs:1.5.15',
                      'org.codehaus.janino:janino:2.5.15',
                      'org.jboss.narayana.tomcat:tomcat-jta:5.6.4.Final',
                      'org.javassist:javassist:' + javassistVersion,
                      'javax.websocket:javax.websocket-api:1.1',
                      'de.benediktmeurer.gwt-slf4j:gwt-slf4j:0.0.2',
                      'org.kie.server:kie-server-services-openshift:' + droolsVersion,
                      'org.infinispan:infinispan-client-hotrod:' + infinispanVersion,
                      'org.infinispan:infinispan-query-dsl:' + infinispanVersion,
                      'org.infinispan:infinispan-remote-query-client:' + infinispanVersion
                      
    pluginLibsRuntime ('com.sun.xml.bind:jaxb-core:2.3.0') {
        force true
    }
    pluginLibsRuntime ('com.sun.xml.bind:jaxb-impl:2.3.0') {
        force true
    }
    pluginLibsRuntime ('com.sun.xml.bind:jaxb-xjc:2.3.0') {
        force true
    }
    pluginLibsRuntime ('org.jboss.spec.javax.servlet.jstl:jboss-jstl-api_1.2_spec:1.1.3.Final') {
        exclude group: 'org.jboss.spec.javax.el'
        exclude group: 'org.jboss.spec.javax.servlet'
    }
    pluginLibsRuntime ('org.jboss.spec.javax.ws.rs:jboss-jaxrs-api_2.0_spec:1.0.1.Final') {
        force true
    }
    
//    pluginLibsRuntime 'org.keycloak:keycloak-core:4.8.3.Final'
}

buildDir = '../../build'

rootProject.jar.exclude('org/langhua/ofbiz/drools/security/**')
rootProject.jar.exclude('org/langhua/ofbiz/tomcat/**')
rootProject.jar.exclude('org/kie/server/**')
rootProject.jar.exclude('org/uberfire/**')
 
task copyKieClasses(type: Copy) {
    from ('../../build/classes/java/main') {
        include 'org/kie/server/**'
    }
    destinationDir = file('webapp/kie-server-' + droolsVersion + '/WEB-INF/classes')

    from ('../../build/classes/java/main') {
        include 'org/kie/server/**'
        include 'org/uberfire/**'
    }
    destinationDir = file('webapp/business-central-' + droolsVersion + '/WEB-INF/classes')
}

task ofbizDroolsJar(type: Jar) {
    baseName = 'ofbiz-' + ofbizVersion + '-drools-' + droolsVersion
    manifest {
        attributes(
            "Implementation-Title": baseName,
            "Created-By": org.gradle.internal.jvm.Jvm.current()
        )
    }
    from ('../../build/classes/java/main') {
        include 'org/langhua/ofbiz/drools/security/**'
        include 'org/langhua/ofbiz/tomcat/**'
    }
    from ('src/main/resources') {
        include '**/beans.xml'
    }
    destinationDir = file('webapp/business-central-' + droolsVersion + '/WEB-INF/lib')
}

rootProject.jar.dependsOn(copyKieClasses, ofbizDroolsJar)
